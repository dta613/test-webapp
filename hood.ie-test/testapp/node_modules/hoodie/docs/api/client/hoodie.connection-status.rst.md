hoodie.connectionStatus
=======================

`hoodie-connection-status` is a browser library to monitor a connection
status. It emits `disconnect` & `reconnect` events if the request status
changes and persists its status.

Example
-------

``` {.sourceCode .js}
var connectionStatus = new ConnectionStatus('https://example.com/ping')

connectionStatus.on('disconnect', showOfflineNotification)
connectionStatus.on('reconnect reset', hideOfflineNotification)
myOtherRemoteApiThing.on('error', connectionStatus.check)
```

Constructor
-----------

``` {.sourceCode .js}
new ConnectionStatus(options)
```

  -------------------------------------------------------------------------
  Argument Typ Description                             Required
           e                                           
  -------- --- --------------------------------------- --------------------
  `options Str Full url to send pings to               Yes
  .url`    ing                                         

  `options Str Defaults to HEAD. Must be valid http    No
  .method` ing verb like `'GET'` or `'POST'` (case     
               insensitive)                            

  `options Num Interval in ms. If set a request is     No
  .interva ber send immediately. The interval starts   
  l`           after each request response. Can also   
               be set to an object to differentiate    
               intervals by connection status, see     
               below                                   

  `options Num Interval in ms while                    No
  .interva ber `connectionStatus.ok` is not `false`.   
  l.connec     If set, a request is send immediately.  
  ted`         The interval starts after each request  
               response.                               

  `options Num Interval in ms while                    No
  .interva ber `connectionStatus.ok` is `false`. If    
  l.discon     set, a request is send immediately. The 
  nected`      interval starts after each request      
               response.                               

  `options Obj Object with `.get()`,                   Defaults to a
  .cache`  ect `.set(properties)` and `.unset()`       [localStorage-based
           or  methods to persist the connection       API](https://github.
           `fa status. Each method must return a       com/gr2m/async-get-s
           lse promise, `.get()` must resolve with the et-store)
           `   current state or an empty object. If    
               set to `false` the connection status    
               will not be persisted.                  

  `options Num time in ms after which a cache shall be No
  .cacheTi ber invalidated. When invalidated on        
  meout`       initialisation, a `reset` event gets    
               triggered on next tick.                 
  -------------------------------------------------------------------------

Example

``` {.sourceCode .js}
var connectionStatus = new ConnectionStatus('https://example.com/ping')

connectionStatus.on('disconnect', showOfflineNotification)
connectionStatus.check()
```

connectionStatus.ready
----------------------

Read-only

Promise that resolves once the ConnectionStatus instance loaded its
current state from the cache.

connectionStatus.ok
-------------------

Read-only

``` {.sourceCode .js}
connectionStatus.ok
```

-   Returns `undefined` if no status yet
-   Returns `true` last check responded ok
-   Returns `false` if last check failed

The state is persisted in cache.

connectionStatus.isChecking
---------------------------

Read-only

``` {.sourceCode .js}
connectionStatus.isChecking
```

-   Returns `undefined` if status not loaded yet, see
    label-connectionStatus-ready
-   Returns `true` if connection is checked continuously
-   Returns `false` if connection is not checked continuously

connectionStatus.check(options)
-------------------------------

``` {.sourceCode .js}
connectionStatus.check(options)
```

  ------------------------------------------------------------------------
  Argument      Type  Description                                   Requir
                                                                    ed
  ------------- ----- --------------------------------------------- ------
  `options.time Numbe Time in ms after which a ping shall be        No
  out`          r     aborted with a `timeout` error                
  ------------------------------------------------------------------------

Resolves without value.

Rejects with:

  name                 status                   message
  -------------------- ------------------------ ---------------------------
  `TimeoutError`       0                        Connection timeout
  `ServerError`        as returned by server    as returned by server
  `ConnectionError`    `undefined`              Server could not be reached

Example

``` {.sourceCode .js}
connectionStatus.check()

.then(function () {
// Connection is good, connectionStatus.ok is true
})

.catch(function () {
// Cannot connect to server, connectionStatus.ok is false
})
```

connectionStatus.startChecking(options)
---------------------------------------

Starts checking connection continuously

``` {.sourceCode .js}
connectionStatus.startChecking(options)
```

  -------------------------------------------------------------------------
  Argument     Typ Description                                          Req
               e                                                        uir
                                                                        ed
  ------------ --- ---------------------------------------------------- ---
  `options.int Num Interval in ms. The interval starts after each       Yes
  erval`       ber request response. Can also be set to an object to    
                   differentiate interval by connection state, see      
                   below                                                

  `options.int Num Interval in ms while `connectionStatus.ok` is not    No
  erval.connec ber `false`. The interval starts after each request      
  ted`             response.                                            

  `options.int Num Interval in ms while `connectionStatus.ok` is        No
  erval.discon ber `false`. The interval starts after each request      
  nected`          response.                                            

  `options.tim Num Time in ms after which a ping shall be aborted with  No
  eout`        ber a `timeout` error.                                   
  -------------------------------------------------------------------------

Resolves without values.

Example

``` {.sourceCode .js}
connectionStatus.startChecking({interval: 30000})
    .on('disconnect', showOfflineNotification)
```

connectionStatus.stopChecking()
-------------------------------

Stops checking connection continuously.

``` {.sourceCode .js}
connectionStatus.stopChecking()
```

Resolves without values. Does not reject.

connectionStatus.reset(options)
-------------------------------

Clears status & cache, aborts all pending requests.

``` {.sourceCode .js}
connectionStatus.reset(options)
```

`options` is the same as in label-Constructor

Resolves without values. Does not reject.

Example

``` {.sourceCode .js}
connectionStatus.reset(options).then(function () {
    connectionStatus.ok === undefined // true
})
```

Events

  ---------- -------------------------------------------------------------
  disconnect Ping fails and `connectionStatus.ok` isnâ€™t `false`

  reconnect  Ping succeeds and `connectionStatus.ok` is `false`

  reset      Cache invalidated on initialisation or
             `connectionStatus.reset()` called
  ---------- -------------------------------------------------------------

Example

``` {.sourceCode .js}
connectionStatus.on('disconnect', function () {})
connectionStatus.on('reconnect', function () {})
connectionStatus.on('reset', function () {})
```

Testing
-------

Local setup

    git clone git@github.com:hoodiehq/hoodie-connection-status.git
    cd hoodie-connection-status
    npm install

Run all tests and code style checks

    npm test

Run all tests on file change

    npm run test:watch

Run specific tests only

    # run unit tests
    node tests/specs 

    # run .check() unit tests
    node tests/specs/check 

    # run walkthrough integration test
    node tests/integration/walkthrough 
