hoodie.account
==============

The account object in the client-side Hoodie API covers all user and
authentication-related operations, and enables you to do previously
complex operations, such as signing up a new user, with only a few lines
of frontend code. Since [data in Hoodie is generally bound to a
user](/camp/hoodieverse/glossary.html#private-user-store), it makes
sense to familiarise yourself with **account** before you move on to
[store](/camp/techdocs/api/client/hoodie.store.html).

`hoodie-account-client` is a JavaScript client for the [Account JSON
API](http://docs.accountjsonapi.apiary.io/). It persists session
information in localStorage (or your own store API) and provides
front-end friendly APIs for the authentication-related operations as
mentioned above.

Example
-------

``` {.sourceCode .js}
hoodie.account.get('session').then(function (sessionProperties) {
  if (!sessionProperties) {
    return redirectToHome()
  }

  renderWelcome(sessionProperties)
}).catch(redirectToHome)

hoodie.account.on('signout', redirectToHome)
```

hoodie.account.validate
-----------------------

Calls the function passed into the Constructor. Returns a Promise that
resolves to `true` by default

``` {.sourceCode .js}
hoodie.account.validate(options)
```

  Argument                Type           Required
  ----------------------- -------------- --------------
  `options.username`      String         No
  `options.password`      String         No
  `options.profile`       Object         No

Resolves with an argument.

Rejects with any errors thrown by the function originally passed into
the Constructor.

Example

``` {.sourceCode .js}
hoodie.account.validate({
    username: 'DocsChicken',
    password: 'secret'
})

.then(function () {
    console.log('Successfully validated!')
})

.catch(function (error) {
    console.log(error) // should be an error about the password being too short
})
```

hoodie.account.hasInvalidSession
--------------------------------

Checks `hoodie.account.session.invalid property`. Returns `true` if user
has invalid session, otherwise `undefined`.

``` {.sourceCode .js}
hoodie.account.hasInvalidSession()
```

hoodie.account.signUp
---------------------

Creates a new user account on the Hoodie server. Does not sign in the
user automatically, label-hoodie-account-signIn must be called
separately.

``` {.sourceCode .js}
hoodie.account.signUp(accountProperties)
```

  Argument                          Type       Required
  --------------------------------- ---------- -----------
  `accountProperties.username`      String     Yes
  `accountProperties.password`      String     Yes

Resolves with `accountProperties`:

``` {.sourceCode .js}
{
    "id": "account123",
    "username": "pat",
    "createdAt": "2016-01-01T00:00.000Z",
    "updatedAt": "2016-01-01T00:00.000Z"
}
```

Rejects with:

  ------------------------------------------------------------------
  InvalidError            Username must be set
  ----------------------- ------------------------------------------
  `SessionError`          Must sign out first

  `ConflictError`         Username **&lt;username&gt;** already
                          exists

  `ConnectionError`       Could not connect to server
  ------------------------------------------------------------------

Example

``` {.sourceCode .js}
hoodie.account.signUp({
    username: 'pat',
    password: 'secret'
}).then(function (accountProperties) {
    alert('Account created for ' + accountProperties.username)
}).catch(function (error) {
    alert(error)
})
```

hoodie.account.signIn
---------------------

Creates a user session

``` {.sourceCode .}
hoodie.account.signIn(options)
```

  Argument                Type      Description    Required
  ----------------------- --------- -------------- -----------
  `options.username`      String    -              Yes
  `options.password`      String    -              Yes

Resolves with `accountProperties`:

``` {.sourceCode .}
{
    "id": "account123",
    "username": "pat",
    "createdAt": "2016-01-01T00:00.000Z",
    "updatedAt": "2016-01-02T00:00.000Z",
    "profile": {
        "fullname": "Dr. Pat Hook"
    }
}
```

Rejects with:

  ------------- ----------------------------------------------------------
  `UnconfirmedE Account has not been confirmed yet
  rror`         

  `Unauthorized Invalid Credentials
  Error`        

  `Error`       A custom error set on the account object, e.g. the account
                 could be blocked due to missing payments

  `ConnectionEr Could not connect to server
  ror`          
  ------------- ----------------------------------------------------------

Example

``` {.sourceCode .}
hoodie.account.signIn({
    username: 'pat',
    password: 'secret'
}).then(function (sessionProperties) {
    alert('Ohaj, ' + sessionProperties.username)
}).catch(function (error) {
    alert(error)
})
```

hoodie.account.signOut
----------------------

Deletes the user’s session

``` {.sourceCode .js}
hoodie.account.signOut()
```

Resolves with `sessionProperties` like label-hoodie-account-signIn, but
without the session id:

``` {.sourceCode .js}
{
    "account": {
        "id": "account123",
        "username": "pat",
        "createdAt": "2016-01-01T00:00.000Z",
        "updatedAt": "2016-01-02T00:00.000Z",
        "profile": {
            "fullname": "Dr. Pat Hook"
        }
    }
}
```

Rejects with:

  ------------ -------------------------------------------------------
  `Error`      A custom error thrown in a `before:signout` hook
  ------------ -------------------------------------------------------

Example

``` {.sourceCode .js}
hoodie.account.signOut().then(function (sessionProperties) {
    alert('Bye, ' + sessionProperties.username)
}).catch(function (error) {
    alert(error)
})
```

hoodie.account.destroy
----------------------

Destroys the account of the currently signed in user.

``` {.sourceCode .js}
hoodie.account.destroy()
```

Resolves with `sessionProperties` like label-hoodie-account-signIn, but
without the session id:

``` {.sourceCode .js}
{
    "account": {
        "id": "account123",
        "username": "pat",
        "createdAt": "2016-01-01T00:00.000Z",
        "updatedAt": "2016-01-02T00:00.000Z",
        "profile": {
            "fullname": "Dr. Pat Hook"
        }
    }
}
```

Rejects with:

  --------------------- --------------------------------------------------
  `Error`               A custom error thrown in a `before:destroy` hook
  `ConnectionError`     Could not connect to server
  --------------------- --------------------------------------------------

Example

``` {.sourceCode .}
hoodie.account.destroy().then(function (sessionProperties) {
    alert('Bye, ' + sessionProperties.username)
}).catch(function (error) {
    alert(error)
})
```

hoodie.account.get
------------------

Returns account properties from local cache.

``` {.sourceCode .js}
hoodie.account.get(properties)
```

  -------------------------------------------------------------------------
  Argumen Type            Description                                 Requi
  t                                                                   red
  ------- --------------- ------------------------------------------- -----
  `proper String or Array When String, only this property gets        No
  ties`   of strings      returned. If array of strings, only passed  
                          properties get returned                     
  -------------------------------------------------------------------------

Returns object with account properties, or `undefined` if not signed in.

Examples

``` {.sourceCode .js}
var properties = hoodie.account.get()
alert('You signed up at ' + properties.createdAt)
var createdAt = hoodie.account.get('createdAt')
alert('You signed up at ' + createdAt)
var properties = hoodie.account.get(['createdAt', 'updatedAt'])
alert('You signed up at ' + properties.createdAt)
```

hoodie.account.fetch
--------------------

Fetches account properties from server.

``` {.sourceCode .js}
hoodie.account.fetch(properties)
```

  -------------------------------------------------------------------------
  Argum Type     Description                                           Requ
  ent                                                                  ired
  ----- -------- ----------------------------------------------------- ----
  `prop String   When String, only this property gets returned. If     No
  ertie or Array array of strings, only passed properties get          
  s`    of       returned. Property names can have '.' separators to   
        strings  return nested properties.                             
  -------------------------------------------------------------------------

Resolves with `accountProperties`:

``` {.sourceCode .js}
{
    "id": "account123",
    "username": "pat",
    "createdAt": "2016-01-01T00:00.000Z",
    "updatedAt": "2016-01-02T00:00.000Z"
}
```

Rejects with:

  ---------------------------- -------------------------------
  `UnauthenticatedError`       Session is invalid
  `ConnectionError`            Could not connect to server
  ---------------------------- -------------------------------

Examples

``` {.sourceCode .js}
hoodie.account.fetch().then(function (properties) {
    alert('You signed up at ' + properties.createdAt)
})
hoodie.account.fetch('createdAt').then(function (createdAt) {
    alert('You signed up at ' + createdAt)
})
hoodie.account.fetch(['createdAt', 'updatedAt']).then(function (properties) {
    alert('You signed up at ' + properties.createdAt)
})
```

hoodie.account.update
---------------------

Update account properties on server and local cache

``` {.sourceCode .js}
hoodie.account.update(changedProperties)
```

  -------------------------------------------------------------------------
  Argument      Type   Description                                   Requir
                                                                     ed
  ------------- ------ --------------------------------------------- ------
  `changedPrope Object Object of properties & values that changed.   No
  rties`               Other properties remain unchanged.            
  -------------------------------------------------------------------------

Resolves with accountProperties:

``` {.sourceCode .js}
{
    "id": "account123",
    "username": "pat",
    "createdAt": "2016-01-01T00:00.000Z",
    "updatedAt": "2016-01-01T00:00.000Z"
}
```

Rejects with:

  --------------------------- -----------------------------------------
  `UnauthenticatedError`      Session is invalid

  `InvalidError`              Custom validation error

  `ConflictError`             Username **&lt;username&gt;** already
                              exists

  `ConnectionError`           Could not connect to server
  --------------------------- -----------------------------------------

Example

``` {.sourceCode .js}
hoodie.account.update({username: 'treetrunks'}).then(function (properties) {
    alert('You are now known as ' + properties.username)
})
```

account.profile.get
-------------------

Returns profile properties from local cache.

``` {.sourceCode .js}
account.profile.get(properties)
```

  -------------------------------------------------------------------------
  Argum Type      Description                                           Req
  ent                                                                   uir
                                                                        ed
  ----- --------- ----------------------------------------------------- ---
  `prop String or When String, only this property gets returned. If     No
  ertie Array of  array of strings, only passed properties get          
  s`    strings   returned. Property names can have . separators to     
                  return nested properties.                             
  -------------------------------------------------------------------------

Returns object with profile properties, falls back to empty object `{}`.
Returns `undefined` if not signed in.

Examples

``` {.sourceCode .js}
var properties = account.profile.get()
alert('Hey there ' + properties.fullname)
var fullname = account.profile.get('fullname')
alert('Hey there ' + fullname)
var properties = account.profile.get(['fullname', 'address.city'])
alert('Hey there ' + properties.fullname + '. How is ' + properties.address.city + '?')
```

account.profile.fetch
---------------------

Fetches profile properties from server.

``` {.sourceCode .js}
account.profile.fetch(options)
```

  --------------------------------------------------------------------------
  Argum Type      Description                                            Req
  ent                                                                    uir
                                                                         ed
  ----- --------- ------------------------------------------------------ ---
  `prop String or When String, only this property gets returned. If      No
  ertie Array of  array of strings, only passed properties get returned. 
  s`    strings   Property names can have '.' separators to return       
                  nested properties.                                     
  --------------------------------------------------------------------------

Resolves with `profileProperties`:

``` {.sourceCode .js}
{
    "id": "account123-profile",
    "fullname": "Dr Pat Hook",
    "address": {
        "city": "Berlin",
        "street": "Adalberststraße 4a"
    }
}
```

Rejects with:

  --------------------------- ---------------------------------
  `UnauthenticatedError`      Session is invalid
  `ConnectionError`           Could not connect to server
  --------------------------- ---------------------------------

Examples

``` {.sourceCode .js}
account.fetch().then(function (properties) {
    alert('Hey there ' + properties.fullname)
})
account.fetch('fullname').then(function (fullname) {
    alert('Hey there ' + fullname)
})
account.fetch(['fullname', 'address.city']).then(function (properties) {
    alert('Hey there ' + properties.fullname + '. How is ' + properties.address.city + '?')
})
```

account.profile.update
----------------------

Update profile properties on server and local cache

``` {.sourceCode .js}
account.profile.update(changedProperties)
```

  -------------------------------------------------------------------------
  Argument      Type  Description                                    Requir
                                                                     ed
  ------------- ----- ---------------------------------------------- ------
  `changedPrope Objec Object of properties & values that changed.    No
  rties`        t     Other properties remain unchanged.             
  -------------------------------------------------------------------------

Resolves with `profileProperties`:

``` {.sourceCode .js}
{
    "id": "account123-profile",
    "fullname": "Dr Pat Hook",
    "address": {
        "city": "Berlin",
        "street": "Adalberststraße 4a"
    }
}
```

Rejects with:

  --------------------------- -------------------------------------
  `UnauthenticatedError`      Session is invalid
  `InvalidError`              Custom validation error
  `ConnectionError`           Could not connect to server
  --------------------------- -------------------------------------

Example

``` {.sourceCode .js}
account.profile.update({fullname: 'Prof Pat Hook'}).then(function (properties) {
    alert('Congratulations, ' + properties.fullname)
})
```

account.request
---------------

Sends a custom request to the server, for things like password resets,
account upgrades, etc.

``` {.sourceCode .js}
account.request(properties)
```

  -------------------------------------------------------------------------
  Argument          Type    Description                            Required
  ----------------- ------- -------------------------------------- --------
  `properties.type` String  Name of the request type, e.g.         Yes
                            "passwordreset"                        

  `properties`      Object  Additional properties for the request  No
  -------------------------------------------------------------------------

Resolves with `requestProperties`:

``` {.sourceCode .js}
{
    "id": "request123",
    "type": "passwordreset",
    "contact": "pat@example.com",
    "createdAt": "2016-01-01T00:00.000Z",
    "updatedAt": "2016-01-01T00:00.000Z"
}
```

Rejects with:

  ---------------------- ----------------------------------------
  `ConnectionError`      Could not connect to server
  `NotFoundError`        Handler missing for "passwordreset"
  `InvalidError`         Custom validation error
  ---------------------- ----------------------------------------

Example

``` {.sourceCode .js}
account.request({type: 'passwordreset', contact: 'pat@example.com'}).then(function (properties) {
    alert('A password reset link was sent to ' + properties.contact)
})
```

account.on
----------

``` {.sourceCode .js}
account.on(event, handler)
```

Example

``` {.sourceCode .js}
account.on('signin', function (accountProperties) {
    alert('Hello there, ' + accountProperties.username)
})
```

account.one
-----------

Call function once at given account event.

``` {.sourceCode .js}
account.one(event, handler)
```

Example

``` {.sourceCode .js}
account.one('signin', function (accountProperties) {
    alert('Hello there, ' + accountProperties.username)
})
```

account.off
-----------

Removes event handler that has been added before

``` {.sourceCode .js}
account.off(event, handler)
```

Example

``` {.sourceCode .js}
account.off('singin', showNotification)
```

Events
------

  ------------------------------------------------------------------------
  Event     Description                            Arguments
  --------- -------------------------------------- -----------------------
  `signup`  New user account created successfully  `accountProperties`
                                                   with
                                                   `.session property`

  `signin`  Successfully signed in to an account   `accountProperties`
                                                   with
                                                   `.session property`

  `signout` Successfully signed out                `accountProperties`
                                                   with
                                                   `.session property`

  `password Email with password reset token sent   
  reset`                                           

  `unauthen Server responded with                  
  ticate`   "unauthenticated" when checking        
            session                                

  `reauthen Successfully signed in with the same   `accountProperties`
  ticate`   username (useful when session has      with
            expired)                               `.session property`

  `update`  Successfully updated an account's      `accountProperties`
            properties                             with
                                                   `.session property`
  ------------------------------------------------------------------------

Hooks
-----

``` {.sourceCode .js}
// clear user’s local store signin and after signout
account.hook.before('signin', function (options) {
    return localUserStore.clear()
})
account.hook.after('signout', function (options) {
    return localUserStore.clear()
})
```

  ------------------------------------------------------------------------
  Hook         Arguments
  ------------ -----------------------------------------------------------
  `signin`     `options` as they were passed into
               `account.signIn(options)`

  `signout`    `{}`
  ------------------------------------------------------------------------

See [before-after-hook](https://www.npmjs.com/package/before-after-hook)
for more information.

Requests
--------

Hoodie comes with a list of built-in account requests, which can be
disabled, overwritten or extended in
[hoodie-account-server](https://github.com/hoodiehq/hoodie-account-server/tree/master/plugin#optionsrequests).

When a request succeeds, an event with the same name as the request type
gets emitted. For example,
`account.request({type: 'passwordreset', contact: 'pat@example.com')`
triggers a `passwordreset` event, with the `requestProperties` passed as
argument.

  --------------------- -----------------------------------------
  `passwordreset`       Request a password reset token
  --------------------- -----------------------------------------

Testing
-------

Local setup

``` {.sourceCode .}
git clone https://github.com/hoodiehq/hoodie-account-client.git
cd hoodie-account-client
```

In Node.js

Run all tests and validate JavaScript Code Style using
[standard](https://www.npmjs.com/package/standard)

``` {.sourceCode .}
npm test
```

To run only the tests

``` {.sourceCode .}
npm run test:node
```

To test hoodie-account-client in a browser you can link it into
[hoodie-account](https://github.com/hoodiehq/hoodie-account), which
provides a dev-server:

``` {.sourceCode .}
git clone https://github.com/hoodiehq/hoodie-account.git
cd hoodie-account
npm install
npm link /path/to/hoodie-account-client
npm start
```

hoodie-account bundles hoodie-account-client on `npm start`, so you need
to restart hoodie-account to see your changes.
